<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org" class="dark h-100" data-bs-theme="dark" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mathis - Raw Knowledge Base</title>
    <!-- Bootstrap & Main CSS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/styles/main.css}"/>
	
	<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
	
    <style>
        .edit-mode-field { display: none; }
        .edit-mode-buttons { display: none; }
        .table .form-control, .table .form-select, .table .form-control-sm {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            height: calc(1.8125rem + 2px);
        }
        .table textarea.form-control {
            height: auto;
            min-height: calc(1.8125rem + 2px);
        }
        pre.metadata-json { white-space: pre-wrap; word-break: break-all; background: #222; color: #8be; border-radius: 4px; padding: 4px;}
    </style>
</head>
<body class="d-flex h-100 text-center text-bg-dark">

<div class="d-flex w-100 h-100 p-3 mx-auto flex-column">
    <header class="mb-auto">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" th:href="@{/}">
                    <img th:src="@{/images/mathis.png}" alt="Mathis Logo" class="logo-navbar">
                    Mathis
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/web/homepage}">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/web/knowledge}">Knowledge</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" th:href="@{/web/rawknowledge}">RawKnowledge</a>
                        </li>
						<li class="nav-item">
							<a class="nav-link" aria-current="page" th:href="@{/web/mathismessage}">Messages</a>
						</li>						
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/web/users}">Users</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/logout}">Logout</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main class="px-3 flex-grow-1">
        <h1 class="mb-4">Raw Knowledge Base</h1>

        <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>

        <div class="table-responsive">
            <table id="rawknowledge-table" class="table table-dark table-striped table-bordered table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Source</th>
                        <th>Processed By</th>
                        <th>Metadata</th>
                        <th>Ingested At</th>
                        <th>Updated At</th>
                        <th>Processed At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="item : ${rawKnowledges}" th:id="'rawknowledge-row-' + ${item.id}">
                        <form th:action="@{/web/rawknowledge/update/{id}(id=${item.id})}" method="post">
                            <input type="hidden" name="id" th:value="${item.id}" />

                            <td th:text="${item.id}"></td>
                            <td>
                                <span class="view-mode-field" th:text="${item.name}"></span>
                                <input type="text" name="name" th:value="${item.name}" class="form-control form-control-sm text-start edit-mode-field" required />
                            </td>
                            <td>
                                <span class="view-mode-field">
                                    <button type="button"
                                            class="btn btn-outline-info btn-sm"
                                            data-bs-toggle="modal"
                                            th:data-bs-target="'#descModal-' + ${item.id}">
                                        View
                                    </button>
                                </span>
                                <span class="edit-mode-field w-100">
                                    <textarea name="description"
                                              th:text="${item.description}"
                                              class="form-control form-control-lg text-start"
                                              style="min-width:300px; min-height:120px;"
                                              required></textarea>
                                </span>
                            </td>
                            <td>
                                <span class="view-mode-field" th:text="${item.source}"></span>
                                <select name="source" class="form-select form-select-sm edit-mode-field" required>
                                    <option th:each="src : ${rawKnowledgeSources}" th:value="${src}" th:text="${src}" th:selected="${src == item.source}"></option>
                                </select>
                            </td>
                            <td>
                                <span class="view-mode-field" th:text="${item.processedBy}"></span>
                                <select name="processedBy" class="form-select form-select-sm edit-mode-field">
                                    <option th:each="proc : ${rawKnowledgeProcessors}" th:value="${proc}" th:text="${proc}" th:selected="${proc == item.processedBy}"></option>
                                    <option th:if="${item.processedBy == null}" value="" selected>None</option>
                                </select>
                            </td>
                            <td>
                                <span class="view-mode-field">
                                    <button type="button"
                                            class="btn btn-outline-info btn-sm"
                                            data-bs-toggle="modal"
                                            th:data-bs-target="'#metadataModal-' + ${item.id}">
                                        View
                                    </button>
                                </span>
                                <span class="edit-mode-field"></span>
                            </td>
                            <td th:text="${#temporals.format(item.ingestedAt, 'dd-MMM-yy HH:mm')}"></td>
                            <td th:text="${#temporals.format(item.updatedAt, 'dd-MMM-yy HH:mm')}"></td>
                            <td th:text="${item.processedAt != null ? #temporals.format(item.processedAt, 'dd-MMM-yy HH:mm') : ''}"></td>
							<td>
							    <div class="btn-group btn-group-sm view-mode-buttons" role="group" sec:authorize="hasAuthority('ROLE_ADMIN')">
							        <button type="button" class="btn btn-secondary edit-button">Edit</button>
							        <a th:href="@{/web/rawknowledge/reprocess/{id}(id=${item.id})}"
							           class="btn btn-warning"
							           th:if="${item.processedBy != null}">
							            Reprocess
							        </a>
							        <a th:href="@{/web/rawknowledge/delete/{id}(id=${item.id})}" class="btn btn-danger">Delete</a>
							    </div>
							    <div class="btn-group btn-group-sm edit-mode-buttons" role="group" sec:authorize="hasAuthority('ROLE_ADMIN')">
							        <button type="submit" class="btn btn-primary">Confirm</button>
							        <button type="button" class="btn btn-secondary cancel-button">Cancel</button>
							    </div>
							</td>

                        </form>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>
    <footer class="mt-auto text-white-50">
        <p>Mathis is open source on <a href="https://github.com/gvincenzi/mathis">GitHub</a>, developed by <a href="https://www.linkedin.com/in/giuseppevincenzi/">Giuseppe Vincenzi</a></p>
    </footer>
</div>

<!-- Modals -->
<div th:each="item : ${rawKnowledges}">
    <!-- Modal for Description -->
    <div class="modal fade"
         th:id="'descModal-' + ${item.id}"
         tabindex="-1"
         aria-labelledby="descModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title" th:id="'descModalLabel-' + ${item.id}">
                        Description: <span th:text="${item.name}"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-start">
                    <div th:utext="${item.description}"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Metadata -->
    <div class="modal fade"
         th:id="'metadataModal-' + ${item.id}"
         tabindex="-1"
         aria-labelledby="metadataModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title" th:id="'metadataModalLabel-' + ${item.id}">
                        Metadata: <span th:text="${item.name}"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-start">
                    <pre class="metadata-json" th:text="${metadataJsonMap[item.id]}"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
	$(document).ready(function() {
	    $('#rawknowledge-table').DataTable({
	        paging: true,
	        searching: true
	    });
	});
		
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.edit-button').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('tr').forEach(row => {
                    row.querySelectorAll('.view-mode-field').forEach(field => field.style.display = 'block');
                    row.querySelectorAll('.edit-mode-field').forEach(field => {
                        field.style.display = 'none';
                        if (field.tagName === 'INPUT' || field.tagName === 'TEXTAREA' || field.tagName === 'SELECT') {
                            if (field.dataset.original !== undefined) {
                                field.value = field.dataset.original;
                            }
                        }
                    });
                    let editButtons = row.querySelector('.edit-mode-buttons');
                    let viewButtons = row.querySelector('.view-mode-buttons');
                    if (editButtons) editButtons.style.display = 'none';
                    if (viewButtons) viewButtons.style.display = 'block';
                });

                const row = this.closest('tr');
                row.querySelectorAll('.view-mode-field').forEach(field => field.style.display = 'none');
                row.querySelectorAll('.edit-mode-field').forEach(field => {
                    field.style.display = 'block';
                    if (field.tagName === 'INPUT' || field.tagName === 'TEXTAREA' || field.tagName === 'SELECT') {
                        field.dataset.original = field.value;
                    }
                });
                this.closest('.view-mode-buttons').style.display = 'none';
                row.querySelector('.edit-mode-buttons').style.display = 'block';
            });
        });

        document.querySelectorAll('.cancel-button').forEach(button => {
            button.addEventListener('click', function() {
                const row = this.closest('tr');
                row.querySelectorAll('.view-mode-field').forEach(field => field.style.display = 'block');
                row.querySelectorAll('.edit-mode-field').forEach(field => {
                    field.style.display = 'none';
                    if (field.tagName === 'INPUT' || field.tagName === 'TEXTAREA' || field.tagName === 'SELECT') {
                        if (field.dataset.original !== undefined) {
                            field.value = field.dataset.original;
                        }
                    }
                });
                this.closest('.edit-mode-buttons').style.display = 'none';
                row.querySelector('.view-mode-buttons').style.display = 'block';
            });
        });
    });
</script>
</body>
</html>
